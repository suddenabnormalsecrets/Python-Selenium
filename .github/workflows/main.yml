name: TruffleHog Secret Scanner

on:
  push:
    branches: 
      - trufflehog
  pull_request:

jobs:
  scan:
    runs-on: pearson-general

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full git history required

      - name: Create results directory
        if: always()
        run: mkdir -p scan-results

      - name: Run TruffleHog
        id: trufflehog
        run: |
          trufflehog git file://. --json --results=verified,unverified,unknown > scan-results/trufflehog-results.json || true

      - name: Show summary of detected secrets
        if: always()
        run: |
          echo "🕵️ TruffleHog Scan Summary:"
          if [ -s scan-results/trufflehog-results.json ]; then
            jq -r '. | select(.metadata != null) | "🔒 Secret in file: \(.source_metadata.filename) at line \(.source_metadata.line)"' scan-results/trufflehog-results.json || echo "✅ No secrets found or invalid JSON format."
          else
            echo "✅ No secrets found."
          fi

      - name: Fail if secrets found
        if: steps.trufflehog.outcome == 'failure'
        run: |
          echo "❌ TruffleHog found potential secrets! Review the summary above."
          exit 1
